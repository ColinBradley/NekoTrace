name: Publish

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Get Version
        id: NekoTraceWebVersion
        uses: KageKirin/get-csproj-version@v1.0.0
        with:
          file: ./NekoTrace.Web/NekoTrace.Web.csproj

      - name: Publish
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir publish
          RELEASE_FILE_PREFIX="NekoTrace-${{ steps.NekoTraceWebVersion.version }}-"
          for publish_name in Portable Linux64SelfContained Win64 Win64SelfContained;
          do
            dotnet publish ./NekoTrace.Web/NekoTrace.Web.csproj -p:PublishProfile=$publish_name
            cd ./NekoTrace.Web/bin/Release/net9.0/publish/$publish_name
            zip_name=${RELEASE_FILE_PREFIX}${publish_name}.zip
            zip -r $zip_name ./*
            mv $zip_name ../../../../../../publish/$zip_name
            cd ../../../../../..
          done
          gh release create -d --generate-notes --fail-on-no-commits ${{ steps.NekoTraceWebVersion.version }} ./publish/*
