@page "/metrics"

@using Microsoft.AspNetCore.Components.QuickGrid
@using ApexCharts
@using NekoTrace.Web.Repositories.Metrics
@using OpenTelemetry.Proto.Metrics.V1

<PageTitle>
	Metrics - NekoTrace
</PageTitle>

<div style="display: grid; grid-template-columns: minmax(0, 1fr) auto; grid-template-rows: auto minmax(0, 1fr);">
	<div class="inline-controls" style="grid-column: span 2; padding: .5em;">
		<label class="inline-control">
			<span>
				Show Resource
			</span>
			<input type="checkbox"
				   @oninput="this.ShowResource_Input" />
		</label>

		<label class="inline-control">
			<span>
				Show Scope Name
			</span>
			<input type="checkbox"
				   @oninput="this.ShowScopeName_Input" />
		</label>
	</div>

	<div style="overflow: auto;">
		<QuickGrid Items="this.Metrics"
				   Theme="dark">

			@if (this.ShowResource is true)
			{
				<PropertyColumn Title="Resource"
								Sortable="true"
								Property="@(m => m.Resource.Key.Value)" />
			}

			@if (this.ShowScopeName is true)
			{
				<PropertyColumn Title="Scope Name"
								Sortable="true"
								Property="@(m => m.ScopeName)" />
			}

			<TemplateColumn Title="Name"
							Sortable="true"
							SortBy="this.MetricNameGridSort"
							InitialSortDirection="SortDirection.Ascending"
							IsDefaultSortColumn="true"
							Context="item">
				<ChildContent>
					<NavLink href="@this.Navigation.GetUriWithQueryParameters(new Dictionary<string, object?>() { [nameof(this.MetricName)] = item.Name, [nameof(this.ResourceKey)] = item.Resource.Key.Value })"
							 title="@item.Description"
							 @onclick="this.MetricLink_Click">
						@item.Name
					</NavLink>
				</ChildContent>
			</TemplateColumn>

			<PropertyColumn Title="Description"
							Sortable="true"
							Property="@(m => m.Description)" />
		</QuickGrid>
	</div>

	@if (this.SelectedMetric is MetricDatapoints metricDatapoints)
	{
		var dataPointGroups = metricDatapoints.DataPoints.GroupBy(p => string.Join(" / ", p.Attributes.OrderBy(a => a.Key, StringComparer.Ordinal).Where(a => a.Value.HasStringValue).Select(a => a.Value.StringValue)));

		<div style="grid-row: 2; grid-column: 2; width: 700px; height: 400px; padding: 2em;">
			<ApexChart Options="this.MetricChartOptions"
					   Title="@metricDatapoints.Name"
					   @ref="this.MetricChart">

				@foreach (var dataPoints in dataPointGroups)
				{
					<ApexPointSeries Items="dataPoints"
									 Name="@(dataPoints.Key ?? metricDatapoints.Name)"
									 XValue="p => DateTimeOffset.FromUnixTimeMilliseconds(Convert.ToInt64(p.TimeUnixNano / 1_000_000))"
									 YValue="e => e.ValueCase switch { NumberDataPoint.ValueOneofCase.AsInt => Convert.ToDecimal(e.AsInt), _ => Convert.ToDecimal(e.AsDouble) }" />
				}
			</ApexChart>
		</div>
	}
	else if (this.SelectedMetric is MetricHistograms metricHistograms)
	{
		<div style="grid-row: 2; grid-column: 2; width: 700px; height: 400px; padding: 2em;">
			<ApexChart Options="this.HistogramChartOptions"
					   Title="@metricHistograms.Name"
					   @ref="this.HistogramChart">
				@{
					var areAllSameBounds = metricHistograms.Histograms.Select(h => h.Value.MaxBy(s => s.Key).Value.ExplicitBounds.Last()).ToArray();
				}
				@foreach(var histogramGroup in metricHistograms.Histograms)
				{
					var latestSet = histogramGroup.Value.MaxBy(s => s.Key).Value;
					var items = latestSet.ExplicitBounds.Select((bound, index) => new HistogramItem(latestSet.BucketCounts[index], bound)).Where(i => i.Count > 0).ToArray();

					<ApexPointSeries Items="items"
									 Name="@histogramGroup.Key"
									 XValue="i => i.Bound.ToString()"
									 YValue="i => i.Count"
									 SeriesType="SeriesType.Bar"  />
				}
			</ApexChart>
		</div>
	}
</div>
