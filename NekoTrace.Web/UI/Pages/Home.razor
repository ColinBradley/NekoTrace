@page "/"

@using Microsoft.AspNetCore.Components.QuickGrid
@using System.Collections.Immutable

@{
	var isHalloween = DateTimeOffset.Now is { Month: 10, Day: >= 15 };
	var isChristmas = DateTimeOffset.Now is { Month: 12, Day: >= 12 };

	var title = 
		isHalloween 
			? "NecroTrace 🎃" 
			: isChristmas
				? "Nekomas 🎄"
				: "NekoTrace";
}

<PageTitle>
	Traces - @title @sAssemblyVersion
</PageTitle>

<div class="page">

	<div class="inline-controls" style="flex-wrap: wrap; padding: .5em; grid-column: span 2;">

		<label>
			<span>
				Attribute Filter
			</span>
			<input value="@this.SpanAttributeFilter"
				   @onchange="this.SpanAttributeFilter_Change" />
		</label>

		<button id="add-column-option-button"
				popovertarget="add-column-popover">
			Add Column…
		</button>

		<div id="add-column-popover"
			 anchor="add-column-option-button"
			 popover
			 style="position-area: y-end;">
			<form class="controls"
				  @onsubmit="this.AddColumnForm_Submit">
				<label>
					<span>
						Value
					</span>
					<input @bind="this.NewColumnValue"
						   @bind:event="oninput"
						   autofocus
						   list="common-span-attributes-items" />
				</label>
				<button type="submit"
						disabled="@(string.IsNullOrWhiteSpace(this.NewColumnValue))">
					Add
				</button>
			</form>
		</div>

		<label>
			<span>
				Span Color Selector
			</span>
			<input value="@this.EffectiveSpanColorSelector"
				   @onchange="this.SpanColorSelector_Change"
				   list="common-span-attributes-items" />
			<datalist id="common-span-attributes-items">
				@foreach (var spanAttributeKey in this.RootSpanAttributeKeys)
				{
					<option>@spanAttributeKey</option>
				}
			</datalist>
		</label>

		<form method="POST"
			  action="/api/trace-files"
			  enctype="multipart/form-data"
			  style="padding: 0">
			<label>
				<span>
					Import Traces
				</span>
				<input name="spans"
					   type="file"
					   accept=".json.gz,.json"
					   multiple
					   onchange="this.form.submit();" />
			</label>
		</form>
	</div>

	<div class="traces">

		@if (!this.FilteredTraces.Any())
		{
			<div style="grid-area: 1/1; align-self: stretch; display: grid; align-content: center; justify-items: center; opacity: .5; user-select: none;">
				<h2 style="margin-top: 40px;">
					@if (isHalloween)
					{
						@:Necro the neko doesn't see any traces just yet.
					}
					else if (isChristmas)
					{
						@:Evie the christmas neko doesn't see any traces just yet.
					}
					else
					{
						@:Olaf the neko doesn't see any traces just yet.
					}
				</h2>

				@if (isHalloween)
				{
					<img src="@this.Assets["images/NecroNeko.png"]"
						 alt="Necro the neko"
						 title="Original Art by Chaos Cola https://bsky.app/profile/chaos-cola.com, remixed by Braya Oal"
						 style="max-width: 50ch;" />
				}
				else if (isChristmas)
				{
					<img src="@this.Assets["images/ChristmasEvieNeko.png"]"
						 alt="Evie the christmas neko"
						 title="Original Art by Chaos Cola https://bsky.app/profile/chaos-cola.com, remixed by Braya Oal"
						 style="max-width: 50ch;" />
				}
				else
				{
					<img src="@this.Assets["images/OlafLabCoat.webp"]"
						 alt="Olaf the neko"
						 title="Art by Chaos Cola https://bsky.app/profile/chaos-cola.com"
						 style="max-width: 50ch;" />
				}
			</div>
		}

		<QuickGrid Items="this.FilteredTraces"
				   Virtualize="true"
				   Theme="dark"
				   ItemKey="t => t.Id"
				   ItemSize="28"
				   style="@(this.TracesGridStyle + "; grid-area: 1/1;")">

			<TemplateColumn Title="Start Time"
							SortBy="this.TraceStartGridSort"
							Sortable="true"
							IsDefaultSortColumn="true"
							InitialSortDirection="SortDirection.Descending"
							Align="Align.Right">
				<ColumnOptions>
					<div class="controls">
						<label>
							<span>
								Start Time
							</span>
							<input type="datetime-local"
								   value="@this.StartTime"
								   @oninput="this.StartTime_Input" />
						</label>

						<label>
							<span>
								End Time
							</span>
							<input type="datetime-local"
								   value="@this.EndTime"
								   @oninput="this.EndTime_Input" />
						</label>
					</div>
				</ColumnOptions>

				<ChildContent>
					<div>
						@context.Start.ToString("HH:mm:ss.fff")
					</div>
				</ChildContent>
			</TemplateColumn>

			<TemplateColumn Title="Name"
							Align="Align.Right">
				<ColumnOptions>
					<div class="trace-names">
						@foreach (var nameCount in this.TraceNamesWithCounts)
						{
							string toggleHref;
							bool isIncluded;
							string queryParameterName;
							ImmutableHashSet<string> newItems;
							if (this.ExclusiveTraceNames is null)
							{
								queryParameterName = nameof(this.IgnoredTraceNames);
								isIncluded = !this.IgnoredTraceNamesSet.Contains(nameCount.Name);
								if (isIncluded)
								{
									newItems = this.IgnoredTraceNamesSet.Add(nameCount.Name);
								}
								else
								{
									newItems = this.IgnoredTraceNamesSet.Remove(nameCount.Name);
								}
							}
							else
							{
								queryParameterName = nameof(this.ExclusiveTraceNames);
								isIncluded = this.ExclusiveTraceNamesSet.Contains(nameCount.Name);

								if (isIncluded)
								{
									newItems = this.ExclusiveTraceNamesSet.Remove(nameCount.Name);
								}
								else
								{
									newItems = this.ExclusiveTraceNamesSet.Add(nameCount.Name);
								}
							}

							toggleHref = this.Navigation.GetUriWithQueryParameter(queryParameterName, newItems.Count is 0 ? null : string.Join('|', newItems));

							<div class="trace-name-toggle @(isIncluded ? "included" : "excluded")">
								<a href="@toggleHref" class="toggler">
									<input type="checkbox" checked="@isIncluded" />
								</a>
								<a href="@this.Navigation.GetUriWithQueryParameters(new Dictionary<string, object?>([new(nameof(this.IgnoredTraceNames), null), new(nameof(this.ExclusiveTraceNames), nameCount.Name)]))">
									@nameCount.Name
								</a>
								<span class="count">
									@nameCount.Count
								</span>
							</div>
						}
					</div>
				</ColumnOptions>

				<ChildContent>
					<NavLink href="@this.Navigation.GetUriWithQueryParameters(new Dictionary<string, object?>([new(nameof(this.TraceId), context.Id), new(nameof(TraceViewComponent.SelectedSpanId), null)]))"
							 title="@(context.RootSpan?.Name ?? context.Id)">
						@(context.RootSpan?.Name ?? context.Id)
					</NavLink>
				</ChildContent>
			</TemplateColumn>

			<TemplateColumn Title="Has Error"
							SortBy="this.TraceHasErrorGridSort"
							Sortable="true"
							Align="Align.Right">
				<ColumnOptions>
					<div class="has-error-options">
						<label>
							<input type="checkbox" @onchange="() => this.ToggleHasError(true)" checked="@(this.HasError is true)" />
							<span>
								True
							</span>
						</label>
						<label>
							<input type="checkbox" @onchange="() => this.ToggleHasError(false)" checked="@(this.HasError is false)" />
							<span>
								False
							</span>
						</label>
					</div>
				</ColumnOptions>

				<ChildContent>
					@if (context.HasError)
					{
						<span class="trace-error-true">
							true
						</span>
					}
					else
					{
						<span class="trace-error-false">
							false
						</span>
					}
				</ChildContent>
			</TemplateColumn>

			<PropertyColumn Title="Spans"
							Property="@(t => t.Spans.Count)"
							Sortable="true"
							Align="Align.Right">
				<ColumnOptions>
					<div class="controls">
						<label>
							<span>
								Min
							</span>
							<input type="number"
								   value="@this.SpansMinimum"
								   min="2"
								   @onchange="this.SpansMinimum_Change" />
						</label>
					</div>
				</ColumnOptions>
			</PropertyColumn>

			<PropertyColumn Title="Duration"
							Property="@(t => t.Duration)"
							Sortable="true"
							Align="Align.Right">
				<ColumnOptions>
					<div class="controls">
						<label>
							<span>
								Min (seconds)
							</span>
							<input type="number"
								   value="@this.DurationMinimum"
								   min="0"
								   step="0.01"
								   @onchange="this.DurationMinimum_Change" />
						</label>
						<label>
							<span>
								Max (seconds)
							</span>
							<input type="number"
								   value="@this.DurationMaximum"
								   min="0.0001"
								   step="0.1"
								   @onchange="this.DurationMaximum_Change" />
						</label>
					</div>
				</ColumnOptions>
			</PropertyColumn>

			@foreach (var customColumn in this.EffectiveCustomColumns)
			{
				<PropertyColumn Title="@customColumn"
								Property="@(t => t.TryGetRootSpanAttribute(customColumn))"
								Sortable="true"
								Align="Align.Right">
					<ColumnOptions>
						<div class="controls">
							<button @onclick="() => this.RemoveColumnButton_Click(customColumn)">
								Remove
							</button>
						</div>
					</ColumnOptions>
				</PropertyColumn>
			}
		</QuickGrid>
	</div>

	<!-- Note: Ideally, this is conditionally rendered, but https://github.com/dotnet/aspnetcore/issues/57746 causes us to not dynamically use components with [SupplyParameterFromQuery] -->
	<TraceViewComponent TraceId="@this.TraceId"
						SpanColorSelector="@this.SpanColorSelector"
						IsSmallMode="true" />
</div>
